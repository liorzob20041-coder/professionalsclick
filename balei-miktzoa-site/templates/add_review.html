{% extends "base.html" %}
{% block title %}הוספת ביקורת{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{{ static_url('css/add_review.css') }}">
{% endblock %}


{% block content %}
<div class="add-review-page">
  <h1>הוספת ביקורת</h1>
  {% if success_message %}
    <p class="ar-success" role="status" aria-live="polite">{{ success_message }}</p>
  {% endif %}

  <form class="add-review-form" method="POST" action="{{ url_for('add_review', lang=lang) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    {# === חיפוש יחיד: "שם עובד — מקצוע" או "שם העסק" === #}
    <label for="workerSearch">בחר עובד:</label>
    <input
      type="text"
      id="workerSearch"
      class="full"
      placeholder="התחל להקליד: שם עובד — מקצוע או שם העסק…"
      list="workersList"
      autocomplete="off"
      inputmode="search"
      required
    >

    <datalist id="workersList">
      {% for w in workers %}
        {% set biz = (w.company_name or w.business or w.company or w.business_name)|default('', true) %}
        {# 1) שם עובד — מקצוע #}
        <option data-id="{{ w.worker_id }}" value="{{ w.name }} — {{ w.field }}"></option>
        {# 2) שם העסק (אם קיים) #}
        {% if biz %}
          <option data-id="{{ w.worker_id }}" value="{{ biz }}"></option>
        {% endif %}
      {% endfor %}
    </datalist>

    {# שדה מוסתר להגשה לשרת (worker_id) #}
    <input type="hidden" id="worker_id" name="worker_id" value="">

    <label for="author">שמך:</label>
    <input type="text" id="author" name="author" required>

    <!-- דירוג -->
    <label class="full" for="ratingVal">דירוג (1–5, כולל חצאים):</label>
    <input type="number" id="ratingVal" name="rating" min="1" max="5" step="0.5" required hidden>

    <div id="ratingWidget"
         class="stars-ctrl full"
         role="slider"
         aria-label="בחרו דירוג בין 1 ל־5 (כולל חצאים)"
         aria-valuemin="1" aria-valuemax="5" aria-valuenow="0"
         tabindex="0">

      <div class="stars-display" aria-hidden="true">
        <span class="stars-bg">★★★★★</span>
        <span class="stars-fg">★★★★★</span>
      </div>

      <div class="stars-note">
        דירוג: <b id="ratingText">—</b>/5
        <small class="hint">כולל חצאים</small>
      </div>
    </div>

    <label for="text" class="full">ביקורת:</label>
    <textarea id="text" name="text" rows="4" required class="full"></textarea>

    <button type="submit">שלח ביקורת</button>
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
{{ super() }}

<script>
/* ==== חיפוש → worker_id: עובד "שם — מקצוע" וגם שם עסק ==== */
(() => {
  const search = document.getElementById('workerSearch');
  const hidden = document.getElementById('worker_id');
  const dl     = document.getElementById('workersList');
  const form   = search?.form;

  if (!search || !hidden || !dl) return;

  // בניית מפה מהירה של תווית→ID, כולל נירמול תווים/רווחים/מקפים (— – -)
  const labelToId = new Map();
  const normToId  = new Map();

  const norm = (s) => (s || '')
    .toLowerCase()
    .replace(/\s+/g, '')
    .replace(/[()\-—–.,:;'"״׳]/g, '');

  Array.from(dl.options).forEach(o => {
    const label = (o.value || '').trim();
    const id = o.dataset.id || '';
    if (!label || !id) return;
    labelToId.set(label, id);
    normToId.set(norm(label), id);
  });

  function findId(text){
    const raw = (text || '').trim();
    if (!raw) return '';

    // 1) התאמה מדויקת (מועדף)
    if (labelToId.has(raw)) return labelToId.get(raw);

    const low = raw.toLowerCase();

    // 2) מתחיל ב- (מועיל בזמן הקלדה)
    for (const [k,id] of labelToId){
      if (k.toLowerCase().startsWith(low)) return id;
    }

    // 3) מכיל
    for (const [k,id] of labelToId){
      if (k.toLowerCase().includes(low)) return id;
    }

    // 4) התאמה מנורמלת (מתעלמת מסוגריים/מקפים/רווחים)
    const n = norm(raw);
    if (normToId.has(n)) return normToId.get(n);

    return '';
  }

  function commit(){ hidden.value = findId(search.value) || ''; }

  // עדכון רציף + בחירה מהרשימה
  search.addEventListener('input', commit);
  search.addEventListener('change', commit);
  search.addEventListener('blur',   commit);

  // Enter ללא בחירה מפורשת — מאמתים שיש התאמה
  search.addEventListener('keydown', (e) => {
    if (e.key === 'Enter'){
      commit();
      if (!hidden.value){
        e.preventDefault();
        search.setCustomValidity('לא נמצאה התאמה. בחרו מהרשימה או הקלידו מדויק יותר (שם — מקצוע או שם העסק).');
        search.reportValidity();
        setTimeout(() => search.setCustomValidity(''), 1500);
      }
    }
  });

  // ולידציה לפני שליחה — חייב worker_id
  form?.addEventListener('submit', (e) => {
    commit();
    if (!hidden.value){
      e.preventDefault();
      search.setCustomValidity('אנא בחרו בעל מקצוע מהרשימה.');
      search.reportValidity();
      setTimeout(() => search.setCustomValidity(''), 1500);
    }
  });
})();
</script>

<script>
/* ==== ווידג'ט הכוכבים — ללא שינוי ==== */
(() => {
  const POS_BIAS_PX    = 8;
  const HALF_FUDGE_PCT = 1.2;

  const widget   = document.getElementById('ratingWidget');
  const display  = widget.querySelector('.stars-display');
  const spanBG   = widget.querySelector('.stars-bg');
  const spanFG   = widget.querySelector('.stars-fg');
  const hidden   = document.getElementById('ratingVal');
  const label    = document.getElementById('ratingText');

  let committed = 0;
  let dragging  = false;

  const clamp = v => Math.max(1, Math.min(5, v));

  function quantizeHalfBiased(v){
    v = clamp(v);
    const i = Math.floor(v), f = v - i;
    if (v <= 1) return 1;
    if (v >= 5) return 5;
    return (f < 0.45) ? (i + 0.5) : (i + 1.0);
  }

  function visualPercent(val){
    let pct = (val / 5) * 100;
    if (val % 1 !== 0) pct = Math.max(0, pct - HALF_FUDGE_PCT);
    return Math.min(100, pct);
  }

  function rawValueFromEvent(e){
    const r = spanBG.getBoundingClientRect();
    const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
    let ratio = (clientX - r.left + POS_BIAS_PX) / r.width;
    ratio = Math.max(0, Math.min(1, ratio));
    return ratio * 5;
  }

  function paint(val){
    spanFG.style.setProperty('--p', visualPercent(val) + '%');
    label.textContent = val ? (val % 1 === 0 ? val.toFixed(0) : val.toFixed(1)) : '—';
    widget.setAttribute('aria-valuenow', String(val || 0));
  }
  function commit(val){ committed = val; hidden.value = String(val); paint(val); }
  function preview(e){ paint(quantizeHalfBiased(rawValueFromEvent(e))); }

  display.addEventListener('pointerenter', preview);
  display.addEventListener('pointermove',  e => { if (!dragging) preview(e); });
  display.addEventListener('pointerleave', () => paint(committed || 0));
  display.addEventListener('pointerdown', e => {
    dragging = true;
    display.setPointerCapture?.(e.pointerId);
    commit(quantizeHalfBiased(rawValueFromEvent(e)));
  });
  display.addEventListener('pointermove', e => { if (dragging) preview(e); });
  display.addEventListener('pointerup',   e => { dragging = false; commit(quantizeHalfBiased(rawValueFromEvent(e))); });
  display.addEventListener('pointercancel', () => { dragging = false; paint(committed || 0); });

  display.addEventListener('touchstart', e => { e.preventDefault(); commit(quantizeHalfBiased(rawValueFromEvent(e))); }, {passive:false});
  display.addEventListener('touchmove',  e => { e.preventDefault(); preview(e);                                   }, {passive:false});
  display.addEventListener('touchend',   e => { e.preventDefault(); paint(committed || 0);                       }, {passive:false});

  widget.addEventListener('keydown', e => {
    let v = committed || 1;
    if (e.key === 'ArrowRight' || e.key === 'ArrowUp'){   e.preventDefault(); v = clamp(v + 0.5); commit(v); }
    if (e.key === 'ArrowLeft'  || e.key === 'ArrowDown'){ e.preventDefault(); v = clamp(v - 0.5); commit(v); }
    if (e.key === 'Home'){ e.preventDefault(); commit(1); }
    if (e.key === 'End'){  e.preventDefault(); commit(5); }
  });

  paint(0);
})();
</script>
{% endblock %}
