<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×‘×¢×œ×™ ××§×¦×•×¢ ×‘×§×œ×™×§ â€” ××—×©×‘×•×Ÿ</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/estimate.css') }}">
</head>
<body>
  {% set t = i18n_est or {} %}
  {% set categories = [
    {"id": "electricity", "emoji": "âš¡", "label": t.get('categories.electricity', '×—×©××œ')},
    {"id": "plumbing", "emoji": "ğŸš°", "label": t.get('categories.plumbing', '××™× ×¡×˜×œ×¦×™×”')},
    {"id": "painting", "emoji": "ğŸ¨", "label": t.get('categories.painting', '×¦×‘×™×¢×”')},
    {"id": "renovation", "emoji": "ğŸ—ï¸", "label": t.get('categories.renovation', '×©×™×¤×•×¦×™×')}
  ] %}
  <main class="est-page">
    <!-- ×¤×¡ ×¡×˜×˜×•×¡ ×¢×œ×™×•×Ÿ -->
    <section class="est-rail">
      <div class="est-rail__row">
        <div class="est-rail__text">×©××œ×” 1 ××ª×•×š 3</div>
        <div class="est-rail__brand">×‘×¢×œ×™ ××§×¦×•×¢ ×‘×§×œ×™×§</div>
      </div>
      <div class="est-progress" aria-hidden="true">
        <div class="est-progress__bar"></div>
      </div>
    </section>

    <!-- ×›×¨×˜×™×¡ ××¨×›×–×™ -->
    <section class="est-card est-card--wide">
      <div class="est-hint">
        <span class="est-hint__icon" aria-hidden="true">ğŸ’¡</span>
        {{ t.get('ui.greeting', '×”×™×™ ğŸ‘‹ × ×—×©×‘ ×™×—×“ ×˜×•×•×— ××—×™×¨ ××©×•×¢×¨.') }}

      </div>

      <h1 class="est-title">{{ t.get('ui.h1', '××—×©×‘×•×Ÿ ×”×¦×¢×ª ××—×™×¨') }}</h1>
      <p class="est-subtitle">{{ t.get('ui.subtitle', '×¢× ×• ×¢×œ ×›××” ×©××œ×•×ª ×§×¦×¨×•×ª ×•× ×—×©×‘ ×˜×•×•×— ××—×™×¨ ××©×•×¢×¨ ×œ×¤×™ ×”×ª×—×•× ×©×‘×—×¨×ª×.') }}</p>

      <div class="est-layout">
        <!-- ×¤×× ×œ ×—×™×¤×•×© + ×§×˜×’×•×¨×™×•×ª -->
        <section class="est-panel" aria-label="×—×™×¤×•×© ×ª×—×•×">
          <div class="est-panel__search" role="search">
            <span class="sr-only" id="est-search-label">{{ t.get('ui.ask_category', '×‘×—×¨×• ×ª×—×•× ×¢×‘×•×“×”') }}</span>
            <button type="button" class="est-search__lead" aria-hidden="true" tabindex="-1">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <circle cx="11" cy="11" r="6" fill="none" stroke="currentColor" stroke-width="1.6" />
                <path d="M16.5 16.5L20 20" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />

              </svg>
            </button>
            <input type="search" class="est-search__input" placeholder="...×—×™×¤×•×© ××”×™×¨" aria-labelledby="est-search-label">
            <button type="button" class="est-search__btn" aria-label="× ×§×” ××• ×—×¤×©">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <circle cx="11" cy="11" r="6" fill="none" stroke="currentColor" stroke-width="1.6" />
                <path d="M16.5 16.5L20 20" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
              </svg>
            </button>
          </div>

          <div class="est-panel__head">
            <span>{{ t.get('ui.ask_category', '×‘×—×¨×• ×ª×—×•× ×¢×‘×•×“×”') }}</span>
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M12 4l3 4h-6l3-4zm0 5v7m0 4h.01" fill="none" stroke="#C8405A" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </div>

          <ul class="est-panel__list" role="list" aria-label="{{ t.get('ui.ask_category', '×‘×—×¨×• ×ª×—×•× ×¢×‘×•×“×”') }}" data-est-categories>
            {% for cat in categories %}
            <li>
              <button type="button" class="est-row" data-est-category="{{ cat.id }}" data-est-label="{{ cat.label }}" data-est-search="{{ cat.label|lower }}" aria-pressed="false">
                <span class="est-row__emoji" aria-hidden="true">{{ cat.emoji }}</span>
                <span class="est-row__title">{{ cat.label }}</span>
                <span class="est-row__chevron" aria-hidden="true">
                  <svg viewBox="0 0 24 24" focusable="false">
                    <polyline points="10 6 16 12 10 18"></polyline>
                  </svg>
                </span>
              </button>
            </li>
            {% endfor %}
          </ul>
        </section>
        <!-- /×¤×× ×œ -->

        <!-- ×–×¨×™××ª ×”×©××œ×•×ª ×•×”×ª×•×¦××” -->
        <section class="est-flow" aria-live="polite" data-est-flow>
          <header class="est-flow__header">
            <div class="est-flow__badge" aria-hidden="true">ğŸ¤–</div>
            <div>
              <h2 class="est-flow__title">{{ t.get('ui.h1', '××—×©×‘×•×Ÿ ×”×¦×¢×ª ××—×™×¨') }}</h2>
              <p class="est-flow__subtitle">{{ t.get('ui.subtitle', '×¢× ×• ×¢×œ ×›××” ×©××œ×•×ª ×§×¦×¨×•×ª ×•× ×—×©×‘ ×˜×•×•×— ××—×™×¨ ××©×•×¢×¨ ×œ×¤×™ ×”×ª×—×•× ×©×‘×—×¨×ª×.') }}</p>
            </div>
          </header>
          <div class="est-flow__summary hidden" data-est-summary></div>
          <div class="est-flow__body" data-est-body>
            <p class="est-flow__placeholder">{{ t.get('ui.greeting', '×”×™×™ ğŸ‘‹ × ×—×©×‘ ×™×—×“ ×˜×•×•×— ××—×™×¨ ××©×•×¢×¨.') }}</p>
          </div>
          <footer class="est-flow__footer">
            <button type="button" class="est-reset" data-est-reset hidden>××™×¤×•×¡ ×‘×—×™×¨×”</button>
          </footer>
        </section>
      </div>
    </section>
  </main>
    <script id="est-i18n" type="application/json">{{ t|tojson }}</script>
    <script id="est-cats" type="application/json">{{ categories|tojson }}</script>
    <script>
    // ×§×¨×™××” ×‘×˜×•×—×” ×©×œ ×”-JSON ×©×”×•×–×¨×§
    const i18n = JSON.parse(document.getElementById('est-i18n')?.textContent || '{}');
    const categories = JSON.parse(document.getElementById('est-cats')?.textContent || '[]');
    </script>
  <script>
    (function(){

      const lang = (document.documentElement.getAttribute('lang') || 'he').toLowerCase();
      const els = {
        list: document.querySelector('[data-est-categories]'),
        body: document.querySelector('[data-est-body]'),
        summary: document.querySelector('[data-est-summary]'),
        reset: document.querySelector('[data-est-reset]'),
        search: document.querySelector('.est-search__input'),
        searchBtn: document.querySelector('.est-search__btn')
      };
      const categoryButtons = Array.from(document.querySelectorAll('[data-est-category]'));
      const state = {
        category: null,
        categoryLabel: '',
        job: null,
        jobLabel: '',
        subtype: null,
        subtypeLabel: '',
        answers: {},
        questions: [],
        resultNote: ''
      };
      const fallback = {
        'ui.ask_category': '×‘×—×¨×• ×ª×—×•× ×¢×‘×•×“×”',
        'ui.choose_job': '××™×–×• ×¢×‘×•×“×” ×‘×“×™×•×§ ×¦×¨×™×š?',
        'ui.where_exactly': '××™×–×” ×¡×•×’ ×¢×‘×•×“×” ×‘×“×™×•×§?',
        'ui.loading_jobs': '×˜×•×¢×Ÿ ×¢×‘×•×“×•×ª ××ª××™××•×ªâ€¦',
        'ui.preparing_opts': '××›×™×Ÿ ××¤×©×¨×•×™×•×ªâ€¦',
        'ui.loading_questions': '×˜×•×¢×Ÿ ×©××œ×•×ª ××ª××™××•×ªâ€¦',
        'ui.computing': '××—×©×‘ ×ª×•×¦××”â€¦',
        'ui.err_load_opts': 'âš ï¸ ×‘×¢×™×” ×‘×˜×¢×™× ×ª ×”××¤×©×¨×•×™×•×ª. × × ×¡×” ×©×•×‘.',
        'ui.err_load_subs': 'âš ï¸ ×‘×¢×™×” ×‘×˜×¢×™× ×ª ×”××¤×©×¨×•×™×•×ª.',
        'ui.err_load_qs': 'âš ï¸ ××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×©××œ×•×ª.',
        'ui.err_quote': 'âš ï¸ ×©×’×™××” ×‘×”×‘××ª ×”×¦×¢×ª ×”××—×™×¨.',
        'ui.field_label': '×ª×—×•×:',
        'ui.job_label': '×¢×‘×•×“×”:',
        'ui.where_label': '×ª×ª-×¡×•×’:',
        'ui.range_label': '×˜×•×•×— ××—×™×¨ ××©×•×¢×¨:',
        'ui.details_label': '×¤×™×¨×•×˜:',
        'ui.greeting': '×”×™×™ ğŸ‘‹ × ×—×©×‘ ×™×—×“ ×˜×•×•×— ××—×™×¨ ××©×•×¢×¨.',
        'ui.subtitle': '×¢× ×• ×¢×œ ×›××” ×©××œ×•×ª ×§×¦×¨×•×ª ×•× ×—×©×‘ ×˜×•×•×— ××—×™×¨ ××©×•×¢×¨ ×œ×¤×™ ×”×ª×—×•× ×©×‘×—×¨×ª×.',
        'ui.result_note': '×”×˜×•×•×— ××‘×•×¡×¡ ×¢×œ × ×ª×•× ×™× ×©×œ ×¤×¨×•×™×§×˜×™× ×××™×ª×™×™×.',
        'ui.compute_btn': '×—×©×‘ ×˜×•×•×— ××—×™×¨',
        'ui.add_more': '× ×•×¡×™×£ ×¢×‘×•×“×” × ×•×¡×¤×ª ×œ×—×™×©×•×‘ ×”××¦×˜×‘×¨.',
        'ui.no_jobs': '×œ× × ××¦××• ×¢×‘×•×“×•×ª ×–××™× ×•×ª ×œ×ª×—×•× ×©× ×‘×—×¨.',
        'ui.no_subtypes': '××™×Ÿ ×ª×ª×™-×¡×•×’ ×–××™× ×™× ×œ×¢×‘×•×“×” ×”×–×•.',
        'ui.add_job_btn': '×”×•×¡×¤×ª ×¢×‘×•×“×” × ×•×¡×¤×ª'
      };

      function t(key){
        return (i18n && Object.prototype.hasOwnProperty.call(i18n, key)) ? i18n[key] : (fallback[key] || '');
      }

      function setBodyContent(node){
        if (!els.body) return;
        els.body.innerHTML = '';
        if (typeof node === 'string'){
          els.body.innerHTML = node;
        } else if (node){
          els.body.appendChild(node);
        }
      }

      function makeParagraph(text, className){
        const p = document.createElement('p');
        p.textContent = text;
        if (className) p.className = className;
        return p;
      }

      function showLoading(key){
        const wrap = document.createElement('div');
        wrap.className = 'est-loading';
        wrap.textContent = t(key) || key;
        setBodyContent(wrap);
      }

      function showError(key){
        const div = document.createElement('div');
        div.className = 'est-error';
        div.textContent = typeof key === 'string' && key.startsWith('âš ï¸') ? key : (t(key) || key || '×‘×¢×™×” ×–×× ×™×ª.');
        setBodyContent(div);
      }

      function updateSummary(){
        if (!els.summary) return;
        const parts = [];
        if (state.categoryLabel){
          parts.push({ label: t('ui.field_label'), value: state.categoryLabel });
        }
        if (state.jobLabel){
          parts.push({ label: t('ui.job_label'), value: state.jobLabel });
        }
        if (state.subtypeLabel){
          parts.push({ label: t('ui.where_label'), value: state.subtypeLabel });
        }
        els.summary.innerHTML = '';
        if (!parts.length){
          els.summary.classList.add('hidden');
        } else {
          parts.forEach(part => {
            const badge = document.createElement('span');
            const strong = document.createElement('strong');
            strong.textContent = part.label;
            badge.appendChild(strong);
            badge.appendChild(document.createTextNode(' ' + (part.value || '')));
            els.summary.appendChild(badge);
          });
          els.summary.classList.remove('hidden');
        }
      }

      function setResetVisibility(flag){
        if (!els.reset) return;
        els.reset.hidden = !flag;
      }

      function highlightCategory(id){
        categoryButtons.forEach(btn => {
          const selected = btn.dataset.estCategory === id;
          btn.classList.toggle('is-selected', selected);
          btn.setAttribute('aria-pressed', selected ? 'true' : 'false');
        });
      }

      function resetFlow(){
        state.category = null;
        state.categoryLabel = '';
        state.job = null;
        state.jobLabel = '';
        state.subtype = null;
        state.subtypeLabel = '';
        state.answers = {};
        state.questions = [];
        state.resultNote = '';
        highlightCategory('');
        updateSummary();
        setResetVisibility(false);
        setBodyContent(makeParagraph(t('ui.greeting'), 'est-flow__placeholder'));
        if (els.search){
          els.search.value = '';
          filterCategories('');
        }
      }

      function filterCategories(term){
        const value = (term || '').trim().toLowerCase();
        categoryButtons.forEach(btn => {
          const label = (btn.dataset.estSearch || '').toLowerCase();
          const match = !value || label.includes(value);
          const li = btn.closest('li');
          if (li){
            li.style.display = match ? '' : 'none';
          }
        });
      }

      async function fetchEstimate(payload){
        const res = await fetch('/api/estimate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(Object.assign({ lang }, payload || {}))
        });
        const data = await res.json();
        if (!res.ok){
          throw new Error(data && data.error ? data.error : 'Request failed');
        }
        return data;
      }

      async function loadJobs(){
        if (!state.category) return;
        showLoading('ui.loading_jobs');
        try {
          const data = await fetchEstimate({ category: state.category });
          renderJobs(data.jobs || []);
        } catch (err){
          console.error(err);
          showError('ui.err_load_opts');
        }
      }

      function renderJobs(jobs){
        const container = document.createElement('div');
        const heading = document.createElement('h3');
        heading.className = 'est-legend';
        heading.textContent = t('ui.choose_job');
        container.appendChild(heading);
        if (!jobs.length){
          container.appendChild(makeParagraph(t('ui.no_jobs'), 'est-flow__placeholder'));
          setBodyContent(container);
          return;
        }
        const list = document.createElement('div');
        list.className = 'est-options';
        jobs.forEach(job => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'est-option';
          btn.dataset.value = job.id;
          btn.textContent = job.label || job.id;
          btn.addEventListener('click', () => selectJob(job));
          list.appendChild(btn);
        });
        container.appendChild(list);
        setBodyContent(container);
      }

      function selectJob(job){
        if (!job) return;
        state.job = job.id;
        state.jobLabel = job.label || job.id;
        state.subtype = null;
        state.subtypeLabel = '';
        state.answers = {};
        state.questions = [];
        state.resultNote = '';
        updateSummary();
        loadSubtypes();
      }

      async function loadSubtypes(){
        if (!state.category || !state.job) return;
        showLoading('ui.preparing_opts');
        try {
          const data = await fetchEstimate({ category: state.category, job: state.job });
          const subtypes = data.subtypes || [];
          if (!subtypes.length){
            state.subtype = state.job;
            state.subtypeLabel = state.jobLabel;
            updateSummary();
            loadQuestions();
            return;
          }
          renderSubtypes(subtypes);
        } catch (err){
          console.error(err);
          showError('ui.err_load_subs');
        }
      }

      function renderSubtypes(subtypes){
        const container = document.createElement('div');
        const heading = document.createElement('h3');
        heading.className = 'est-legend';
        heading.textContent = t('ui.where_exactly');
        container.appendChild(heading);
        if (!subtypes.length){
          container.appendChild(makeParagraph(t('ui.no_subtypes'), 'est-flow__placeholder'));
          setBodyContent(container);
          return;
        }
        const list = document.createElement('div');
        list.className = 'est-options';
        subtypes.forEach(sub => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'est-option';
          btn.dataset.value = sub.id;
          btn.textContent = sub.label || sub.id;
          btn.addEventListener('click', () => selectSubtype(sub));
          list.appendChild(btn);
        });
        container.appendChild(list);
        setBodyContent(container);
      }

      function selectSubtype(sub){
        if (!sub) return;
        state.subtype = sub.id;
        state.subtypeLabel = sub.label || sub.id;
        state.answers = {};
        state.questions = [];
        updateSummary();
        loadQuestions();
      }

      async function loadQuestions(){
        if (!state.category || !state.job || !state.subtype) return;
        showLoading('ui.loading_questions');
        try {
          const data = await fetchEstimate({ category: state.category, job: state.job, subtype: state.subtype });
          state.questions = data.questions || [];
          state.resultNote = data.result_note || state.resultNote;
          renderQuestions(state.questions);
        } catch (err){
          console.error(err);
          showError('ui.err_load_qs');
        }
      }

      function renderQuestions(questions){
        const form = document.createElement('form');
        form.className = 'est-form';
        if (!questions.length){
          form.appendChild(makeParagraph('××™×Ÿ ×©××œ×•×ª × ×•×¡×¤×•×ª. × ×—×©×‘ ××ª ×”×˜×•×•×— ××™×“.', 'est-flow__placeholder'));
        }
        questions.forEach(q => {
          const fieldset = document.createElement('fieldset');
          fieldset.className = 'est-fieldset';
          const legend = document.createElement('legend');
          legend.className = 'est-legend';
          legend.textContent = q.text || '';
          fieldset.appendChild(legend);
          const radios = document.createElement('div');
          radios.className = 'est-radios';
          (q.options || []).forEach(opt => {
            const label = document.createElement('label');
            label.className = 'est-radio';
            const input = document.createElement('input');
            input.type = 'radio';
            input.name = q.id;
            input.value = opt.value;
            input.required = true;
            input.addEventListener('change', () => {
              const siblings = label.parentElement ? Array.from(label.parentElement.querySelectorAll('.est-radio')) : [];
              siblings.forEach(item => {
                item.dataset.checked = item === label ? 'true' : 'false';
              });
            });
            const span = document.createElement('span');
            span.className = 'est-radio__label';
            span.textContent = opt.label || opt.value;
            label.appendChild(input);
            label.appendChild(span);
            if (opt.hint){
              const hint = document.createElement('span');
              hint.className = 'est-radio__hint';
              hint.textContent = opt.hint;
              label.appendChild(hint);
            }
            radios.appendChild(label);
          });
          fieldset.appendChild(radios);
          form.appendChild(fieldset);
        });
        const actions = document.createElement('div');
        actions.className = 'est-form__actions';
        const submit = document.createElement('button');
        submit.type = 'submit';
        submit.className = 'est-btn est-btn--primary';
        submit.textContent = t('ui.compute_btn');
        actions.appendChild(submit);
        form.appendChild(actions);
        form.addEventListener('submit', function(ev){
          ev.preventDefault();
          const formData = new FormData(form);
          const answers = {};
          state.questions.forEach(q => {
            const val = formData.get(q.id);
            if (val){
              answers[q.id] = val;
            }
          });
          if (state.questions.length && Object.keys(answers).length !== state.questions.length){
            showError('×× ×—× ×• ×¦×¨×™×›×™× ××¢× ×” ×œ×›×œ ×”×©××œ×•×ª ×›×“×™ ×œ×—×©×‘ ××—×™×¨.');
            return;
          }
          state.answers = answers;
          computeQuote();
        });
        setBodyContent(form);
      }

      async function computeQuote(){
        showLoading('ui.computing');
        try {
          const data = await fetchEstimate({ category: state.category, job: state.job, subtype: state.subtype, answers: state.answers });
          renderResult(data);
        } catch (err){
          console.error(err);
          showError('ui.err_quote');
        }
      }

      function renderResult(result){
        const wrapper = document.createElement('div');
        wrapper.className = 'est-result';
        const priceTitle = document.createElement('div');
        priceTitle.className = 'est-result__price';
        const rangeLabel = document.createElement('span');
        rangeLabel.textContent = t('ui.range_label') + ' ';
        const rangeValue = document.createElement('strong');
        rangeValue.textContent = result.price || (result.price_min && result.price_max ? `â‚ª${result.price_min}â€“â‚ª${result.price_max}` : '');
        priceTitle.appendChild(rangeLabel);
        priceTitle.appendChild(rangeValue);
        wrapper.appendChild(priceTitle);
        const noteText = result.result_note || state.resultNote || t('ui.result_note');
        if (noteText){
          const noteEl = document.createElement('div');
          noteEl.className = 'est-result__note';
          noteEl.textContent = noteText;
          wrapper.appendChild(noteEl);
        }
        if (result.description){
          const detail = document.createElement('div');
          detail.className = 'est-result__details';
          detail.textContent = t('ui.details_label') + ' ' + result.description;
          wrapper.appendChild(detail);
        }
        if (t('ui.add_more')){
          const extra = document.createElement('div');
          extra.className = 'est-result__details';
          extra.textContent = t('ui.add_more');
          wrapper.appendChild(extra);
        }
        const actions = document.createElement('div');
        actions.className = 'est-form__actions';
        const again = document.createElement('button');
        again.type = 'button';
        again.className = 'est-btn est-btn--ghost';
        again.textContent = t('ui.add_job_btn');
        again.addEventListener('click', () => {
          state.job = null;
          state.jobLabel = '';
          state.subtype = null;
          state.subtypeLabel = '';
          state.answers = {};
          state.questions = [];
          state.resultNote = '';
          updateSummary();
          loadJobs();
        });
        actions.appendChild(again);
        wrapper.appendChild(actions);
        setBodyContent(wrapper);
      }

      categoryButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.estCategory;
          const cat = categories.find(c => c.id === id);
          if (!cat) return;
          if (state.category === id){
            loadJobs();
            return;
          }
          state.category = id;
          state.categoryLabel = cat.label || id;
          state.job = null;
          state.jobLabel = '';
          state.subtype = null;
          state.subtypeLabel = '';
          state.answers = {};
          state.questions = [];
          state.resultNote = '';
          highlightCategory(id);
          updateSummary();
          setResetVisibility(true);
          loadJobs();
        });
      });

      if (els.reset){
        els.reset.addEventListener('click', resetFlow);
      }

      if (els.search){
        els.search.addEventListener('input', (event) => {
          filterCategories(event.target.value);
        });
      }

      if (els.searchBtn){
        els.searchBtn.addEventListener('click', () => {
          if (!els.search) return;
          if (els.search.value){
            els.search.value = '';
            filterCategories('');
          }
          els.search.focus();
        });
      }

      filterCategories('');
    })();
  </script>
</body>
</html>
