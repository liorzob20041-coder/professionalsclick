{% extends "base.html" %}

{% block title %}
  {% if area_label %}{{ field_label }} ב{{ area_label }} – {{ _("site_name") }}
  {% else %}{{ field_label }} – {{ _("site_name") }}{% endif %}
{% endblock %}

{% block head_seo %}
  {% set canonical_base = url_for('show_workers', lang=g.current_lang, field=field, area=area, _external=True) %}
  {% set canonical = (canonical_url if canonical_url is defined and canonical_url else (page is defined and page>1 and (canonical_base ~ '?page=' ~ page)) or canonical_base) %}
  <link rel="canonical" href="{{ canonical }}">

  {% set href_he = (hreflang_urls.he if hreflang_urls is defined and hreflang_urls and hreflang_urls.he
                    else url_for('show_workers', lang='he', field=field, area=area, _external=True)) %}
  {% set href_en = (hreflang_urls.en if hreflang_urls is defined and hreflang_urls and hreflang_urls.en
                    else url_for('show_workers', lang='en', field=field, area=area, _external=True)) %}
  {% set href_ru = (hreflang_urls.ru if hreflang_urls is defined and hreflang_urls and hreflang_urls.ru
                    else url_for('show_workers', lang='ru', field=field, area=area, _external=True)) %}

  <link rel="alternate" hreflang="he" href="{{ href_he }}">
  <link rel="alternate" hreflang="en" href="{{ href_en }}">
  <link rel="alternate" hreflang="ru" href="{{ href_ru }}">
  <link rel="alternate" hreflang="x-default" href="{{ href_he }}">

  {% if page is defined and page|int > 1 %}
    <link rel="prev" href="{{ canonical_base }}{% if page|int > 2 %}?page={{ page|int - 1 }}{% endif %}">
  {% endif %}
  {% if page is defined and has_next %}
    <link rel="next" href="{{ canonical_base }}?page={{ page|int + 1 }}">
  {% endif %}

  {% if g.current_lang == 'he' %}
    {% set meta_description = (area_label and (field_label ~ ' ב' ~ area_label ~ ' – בעלי מקצוע מאומתים, ביקורות אמיתיות ומחירון שקוף.')) or (field_label ~ ' – בעלי מקצוע מאומתים, ביקורות אמיתיות ומחירון שקוף.') %}
    {% set og_title = (area_label and (field_label ~ ' ב' ~ area_label)) or field_label %}
    {% set og_locale = 'he_IL' %}
  {% elif g.current_lang == 'en' %}
    {% set meta_description = (area_label and (field_label ~ ' in ' ~ area_label ~ ' – verified pros, real reviews and transparent pricing.')) or (field_label ~ ' – verified pros, real reviews and transparent pricing.') %}
    {% set og_title = (area_label and (field_label ~ ' in ' ~ area_label)) or field_label %}
    {% set og_locale = 'en_US' %}
  {% else %}
    {% set meta_description = (area_label and (field_label ~ ' в ' ~ area_label ~ ' — проверенные мастера, реальные отзывы и прозрачные цены.')) or (field_label ~ ' — проверенные мастера, реальные отзывы и прозрачные цены.') %}
    {% set og_title = (area_label and (field_label ~ ' в ' ~ area_label)) or field_label %}
    {% set og_locale = 'ru_RU' %}
  {% endif %}

  {% set results_count = workers|length %}
  <meta name="description" content="{{ meta_description }}">
  <meta name="robots" content="{{ 'noindex,follow' if results_count == 0 else 'index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1' }}">

  <meta property="og:type" content="website">
  <meta property="og:site_name" content="{{ _("site_name") }}">
  <meta property="og:locale" content="{{ og_locale }}">
  <meta property="og:locale:alternate" content="he_IL">
  <meta property="og:locale:alternate" content="en_US">
  <meta property="og:locale:alternate" content="ru_RU">
  <meta property="og:title" content="{{ og_title }}">
  <meta property="og:description" content="{{ meta_description }}">
  <meta property="og:url" content="{{ canonical }}">
  <meta property="og:image" content="{{ url_for('static', filename='og/home-' ~ g.current_lang ~ '.jpg', _external=True) }}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content="{{ og_title }}">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ og_title }}">
  <meta name="twitter:description" content="{{ meta_description }}">
  <meta name="twitter:image" content="{{ url_for('static', filename='og/home-' ~ g.current_lang ~ '.jpg', _external=True) }}">

  {% set __lang = (g.current_lang or 'he') %}
  {% set __country = 'IL' %}
  {% set __page = (page|int if page is defined else 1) %}
  {% set __page_size = (page_size|int if page_size is defined else (workers|length)) %}
  {% set __idx_base = ((__page-1) * __page_size if __page>1 else 0) %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "inLanguage": {{ __lang|tojson }},
    "name": {{ og_title|tojson }},
    "numberOfItems": {{ results_count }},
    "itemListOrder": "http://schema.org/ItemListOrderAscending",
    "itemListElement": [
      {% for w in workers %}
      {% set __img = (w.image_filename and url_for('static', filename=w.image_filename, _external=True)) or url_for('static', filename='default-worker.jpg', _external=True) %}
      {
        "@type": "ListItem",
        "position": {{ __idx_base + loop.index }},
        "url": {{ url_for('worker_reviews', worker_id=w.worker_id, lang=g.current_lang, _external=True)|tojson }},
        "item": {
          "@type": "LocalBusiness",
          "name": {{ (w.company_name or w.name)|default('', true)|tojson }},
          {% if w.phone %}"telephone": {{ w.phone|tojson }},{% endif %}
          {% if __img %}"image": {{ __img|tojson }},{% endif %}
          {% if area_label %}
          "address": {"@type": "PostalAddress","addressLocality": {{ area_label|tojson }},"addressCountry": {{ __country|tojson }}},
          {% endif %}
          "areaServed": {% if area_label %}{"@type":"AdministrativeArea","name": {{ area_label|tojson }} }{% else %}{{ (g.current_lang == 'he' and "ישראל" or "Israel")|tojson }}{% endif %},
          "serviceType": {{ (w.field_translated or field_label)|tojson }}
          {% if w.rating and (w.reviews_count is defined and w.reviews_count) %},
          "aggregateRating": {"@type":"AggregateRating","ratingValue": {{ ('%.1f'|format(w.rating|float))|replace(',','.') }},"bestRating": 5,"worstRating": 1,"reviewCount": {{ w.reviews_count|int }}
          }
          {% endif %}
        }
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ]
  }
  </script>

  {% set home_url = url_for_lang('home', _external=True) %}
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[
    {"@type":"ListItem","position":1,"name": {{ (_('site_name') or 'בעלי מקצוע בקליק')|tojson }},"item": {{ home_url|tojson }}},
    {"@type":"ListItem","position":2,"name": {{ (area_label and (field_label ~ ' ' ~ (g.current_lang=='he' and 'ב' or (g.current_lang=='ru' and 'в' or 'in')) ~ ' ' ~ area_label) or field_label)|tojson }},"item": {{ canonical|tojson }}}
  ]}
  </script>

  {% if g.current_lang == 'he' %}
    {% set noun_map = {'שיפוצים':'שיפוצניקים','אינסטלטורים':'אינסטלטורים','חשמלאים':'חשמלאים','מנעולנים':'מנעולנים'} %}
    {% set field_noun = noun_map.get(field_label, field_label) %}
    {% set h1_text = field_noun ~ (area_label and ' ב' ~ area_label or '') %}
    {% set faq_q1 = 'כמה עולה ' ~ field_noun ~ (area_label and ' ב' ~ area_label or '') ~ '?' %}
    {% set faq_a1 = 'המחיר תלוי בהיקף העבודה, זמינות והחומרים. קבלו הערכה התחלתית במחשבון ההצעת מחיר שלנו והשלימו מול בעל המקצוע לאחר ביקור.' %}
    {% set faq_q2 = 'איך בוחרים ' ~ field_noun ~ (area_label and ' ב' ~ area_label or '') ~ '?' %}
    {% set faq_a2 = 'מומלץ לבדוק ניסיון רלוונטי, ביקורות מאומתות, זמינות קרובה והצעת מחיר כתובה. באתר אנו מציגים את כל הנתונים האלה בצורה נוחה.' %}
    {% set faq_q3 = 'האם אפשר לראות ביקורות אמיתיות?' %}
    {% set faq_a3 = 'כן. אנו מציגים חוות דעת מאומתות מלקוחות, כולל תאריך ומידע תמציתי, כדי שתוכלו לקבל החלטה מושכלת.' %}
  {% elif g.current_lang == 'en' %}
    {% set h1_text = field_label ~ (area_label and ' in ' ~ area_label or '') %}
    {% set faq_q1 = 'How much do ' ~ field_label ~ (area_label and ' in ' ~ area_label or '') ~ ' cost?' %}
    {% set faq_a1 = 'Pricing depends on scope, availability and materials. Use our estimate calculator to get a starting range, then confirm onsite.' %}
    {% set faq_q2 = 'How do I choose a reliable pro?' %}
    {% set faq_a2 = 'Check relevant experience, verified reviews, near-term availability and a written quote. We surface these signals clearly.' %}
    {% set faq_q3 = 'Do you show real reviews?' %}
    {% set faq_a3 = 'Yes — we list verified client feedback with dates and concise notes so you can decide with confidence.' %}
  {% else %}
    {% set h1_text = field_label ~ (area_label and ' в ' ~ area_label or '') %}
    {% set faq_q1 = 'Сколько стоят услуги ' ~ field_label ~ (area_label and ' в ' ~ area_label) ~ '?' %}
    {% set faq_a1 = 'Цена зависит от объёма работ, сроков и материалов. Воспользуйтесь нашим калькулятором для стартовой оценки и уточните после осмотра.' %}
    {% set faq_q2 = 'Как выбрать надежного мастера?' %}
    {% set faq_a2 = 'Проверьте релевантный опыт, подтвержденные отзывы, ближайшую доступность и письменную смету. Мы показываем все эти данные.' %}
    {% set faq_q3 = 'У вас настоящие отзывы?' %}
    {% set faq_a3 = 'Да. Мы публикуем проверенные отзывы клиентов с датами и кратким описанием, чтобы вы могли принять взвешенное решение.' %}
  {% endif %}
{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/workers_list.css') }}">
{% endblock %}

{% block content %}
  <div class="main-content theme-bordeaux" data-field="{{ field_slug|default(field_label|lower|replace(' ','-')) }}">

    <nav class="crumbs-min" aria-label="ניווט משני">
      <a href="{{ url_for_lang('home') }}">{{ _('nav_home') if _ else 'דף הבית' }}</a>
      <span>›</span>
      <span class="current">{{ field_label }}{% if area_label %} / {{ area_label }}{% endif %}</span>
    </nav>

    <section class="masthead masthead--ripple" aria-label="כותרת עמוד">
      <div class="dot-grid" aria-hidden="true"></div>
      <div class="click-ripple" aria-hidden="true">
        <span></span><span></span><span></span>
      </div>

      <h1 class="title title--priority">
        <span class="t-field">{{ field_label }}</span>
        {% if area_label %}
          <span class="t-sep"> ב</span>

          <!-- כאן ההחלפה -->
          <span class="t-area-wrap">
            <span class="t-area">{{ area_label }}</span>

            <span class="city-actions" role="group" aria-label="שינוי עיר או חיפוש חדש">
              <button type="button" class="city-switch" id="changeCityBtn" aria-haspopup="true" aria-expanded="false">
                <span class="city-switch__label">שינוי עיר</span>
                <i class="fa-solid fa-chevron-down chev" aria-hidden="true"></i>
              </button>



            </span>
          </span>
        {% endif %}
      </h1>




      <p class="brand-sub">קליק אחד והמקצוען בדרך אליכם</p>

      <div class="trust-pills" role="list" aria-label="הבטחות השירות">
        <span class="pill" role="listitem"><i class="fa-solid fa-shield-halved"></i> מאומת</span>
        <span class="pill" role="listitem"><i class="fa-regular fa-message"></i> ביקורות אמיתיות</span>
        <span class="pill" role="listitem"><i class="fa-solid fa-phone"></i> חייגו בלחיצה</span>
      </div>

      <div class="accent-line" aria-hidden="true"></div>
    </section>

    <div class="results-toolbar" role="region" aria-label="סרגל תוצאות">
      <div class="toolbar-row">
        <button type="button" class="btn-filter" id="filtersOpenBtn" aria-controls="filtersDrawer" aria-expanded="false">
          <i class="fa-solid fa-sliders"></i> סינון
        </button>
        <div class="hint">לטשו את התוצאות עד שתגיעו להתאמה המושלמת.</div>
      </div>

      {% set list_url = url_for('show_workers', lang=g.current_lang, field=field, area=area) %}
      {% set active = [] %}
      {% if request.args.get('open_now') %}{% set _ = active.append('פתוחים עכשיו') %}{% endif %}
      {% if request.args.get('verified') %}{% set _ = active.append('מאומתים') %}{% endif %}
      {% if request.args.get('rating_4p') %}{% set _ = active.append('4★+') %}{% endif %}
      {% if request.args.get('nearby_5km') %}{% set _ = active.append('עד 5 ק״מ') %}{% endif %}
      {% if request.args.get('lang_he') %}{% set _ = active.append('עברית') %}{% endif %}
      {% if request.args.get('lang_en') %}{% set _ = active.append('English') %}{% endif %}
      {% if request.args.get('lang_ru') %}{% set _ = active.append('Русский') %}{% endif %}

      {% if active|length %}
        <div class="chips-scroll" aria-label="מסננים פעילים">
          {% for chip in active %}<span class="chip is-on">{{ chip }}</span>{% endfor %}
          <a class="chip reset" href="{{ list_url }}">נקה</a>
        </div>
      {% endif %}
    </div>

    <div class="results-wrap page-grid">
      <aside class="info-aside" aria-label="מדריך מהיר">
        <div class="aside-block guide-min">
          <h2 class="aside-title">איך לבחור נכון</h2>
          <ul>
            <li>בדקו ניסיון רלוונטי וביקורות עדכניות.</li>
            <li>השוו טווחי מחיר וזמינות קרובה.</li>
            <li>בקשו הצעת מחיר כתובה וממוקדת.</li>
          </ul>
        </div>
        <div class="aside-block faq">
          <h2 class="aside-title">FAQ</h2>
          <details><summary>{{ faq_q1 }}</summary><p>{{ faq_a1 }}</p></details>
          <details><summary>{{ faq_q2 }}</summary><p>{{ faq_a2 }}</p></details>
          <details><summary>{{ faq_q3 }}</summary><p>{{ faq_a3 }}</p></details>
        </div>
      </aside>

      <section class="results-section" aria-label="{{ _('workers_list_aria') }}">
        {% if workers|length == 0 %}
          <div class="empty-state clean" role="status">
            <h3>לא מצאנו תוצאות תואמות</h3>
            <p>נסו לשנות אזור, להסיר מסננים או לעיין בתחומים קרובים.</p>
            <div class="suggestions">
              <a class="chip suggestion" href="{{ url_for_lang('workers', field=field_label, area='מרכז') }}">גוש דן</a>
              <a class="chip suggestion" href="{{ url_for_lang('workers', field=field_label, area='כל הארץ') }}">כל הארץ</a>
              <a class="chip suggestion" href="{{ url_for_lang('niches') }}">תחומים קרובים</a>
            </div>
          </div>
        {% else %}
          <div class="workers-grid" id="workersGrid">
            {% for w in workers %}
              <div class="worker-card">
                {% set image_url = w.image_filename and url_for('static', filename=w.image_filename) or url_for('static', filename='default-worker.jpg') %}
                {% set raw_video = w.video_url or w.video_local %}
                {% if raw_video %}
                  {% if w.video_local and not w.video_url %}
                    {% set video_src = url_for('static', filename=w.video_local) %}
                  {% else %}
                    {% set video_src = raw_video %}
                  {% endif %}
                  {% set kind = video_src|video_kind %}
                {% endif %}

                <div class="card-media">
                  {% if raw_video %}
                    {% if kind == 'mp4' %}
                      <div class="media-player" data-kind="mp4" data-src="{{ video_src }}" data-fallback="{{ image_url }}" style="--poster:url('{{ image_url }}')">
                        <div class="media-dim" aria-hidden="true"></div>
                        <div class="media-inner">
                          <div class="preview"><div class="center-bg"></div><button class="play-overlay" aria-label="{{ _('play_video')|default('נגן וידאו') }}"><span class="triangle"></span></button></div>
                        </div>
                      </div>
                    {% elif kind in ['youtube','vimeo'] %}
                      <div class="media-player" data-kind="embed" data-src="{{ video_src|to_embed_url }}" data-fallback="{{ image_url }}" style="--poster:url('{{ image_url }}')">
                        <div class="media-dim" aria-hidden="true"></div>
                        <div class="media-inner">
                          <div class="preview"><div class="center-bg"></div><button class="play-overlay" aria-label="{{ _('play_video')|default('נגן וידאו') }}"><span class="triangle"></span></button></div>
                        </div>
                      </div>
                    {% else %}
                      <img src="{{ image_url }}" alt="תמונה של {{ w.name }}" class="worker-img" style="width:100%;height:100%;object-fit:cover;">
                    {% endif %}
                  {% else %}
                    <img src="{{ image_url }}" alt="תמונה של {{ w.name }}" class="worker-img" style="width:100%;height:100%;object-fit:cover;">
                  {% endif %}

                  <div class="card-avatar"><img src="{{ image_url }}" alt="תמונת פרופיל קטנה של {{ w.name }}"></div>
                </div>

                <div class="worker-info">
                  <h2 class="worker-name">
                    {{ w.company_name }}
                    {% if w.offers_emergency %}<span class="badge-emer">חירום 24/7</span>{% endif %}
                  </h2>
                  <p class="worker-person-name">({{ w.name }})</p>

                  {% if w.rating %}
                    {% set r = w.rating|float %}
                    {% set full = r|int %}
                    {% set half = 1 if (r - full) >= 0.5 and full < 5 else 0 %}
                    {% set empty = 5 - full - half %}
                    {% set rc = (w.reviews_count if w.reviews_count is defined else None) %}
                    <div class="rating" title="{{ '%.1f'|format(r) }}/5">
                      <span class="rating__stars" aria-hidden="true">
                        {% for i in range(full) %}<i class="fa-solid fa-star"></i>{% endfor %}
                        {% if half %}<i class="fa-solid fa-star-half-stroke"></i>{% endif %}
                        {% for i in range(empty) %}<i class="fa-regular fa-star"></i>{% endfor %}
                      </span>
                      <span class="rating__score">{{ '%.1f'|format(r) }}</span>
                      {% if rc %}
                        <a class="rating__count" href="{{ url_for('worker_reviews', worker_id=w.worker_id, lang=g.current_lang) }}">({{ rc }} ביקורות)</a>
                      {% endif %}
                    </div>
                  {% endif %}

                  {% if w.experience_text %}
                    <p class="info-row"><i class="fa-solid fa-briefcase icon fa-fw" aria-hidden="true"></i>{{ w.experience_text }}</p>
                  {% endif %}

                  {% set bio_short = (w.bio_short or w.description) %}
                  {% if bio_short %}
                    <p class="card-bio">{{ bio_short }}</p>
                    <a class="more-link" href="{{ url_for('worker_reviews', worker_id=w.worker_id, lang=g.current_lang) }}">קראו עוד</a>
                  {% endif %}

                  {% set svc_list = (w.services_list or w.sub_services or []) %}
                  {% if svc_list %}
                    {% set top3 = svc_list[:3] %}
                    <div class="mini-services">
                      <span class="label">התמחויות:</span>
                      <span>{{ ', '.join(top3) }}{% if svc_list|length > 3 %}…{% endif %}</span>
                    </div>
                  {% endif %}

                  {% if w.latest_review %}
                    <p class="info-row"><i class="fa-regular fa-comment-dots icon fa-fw icon--accent" aria-hidden="true"></i>“{{ w.latest_review }}” {% if w.latest_review_author %}- {{ w.latest_review_author }}{% endif %}</p>
                    <a class="reviews-button" href="{{ url_for('worker_reviews', worker_id=w.worker_id, lang=g.current_lang) }}">{{ _('more_reviews') }}</a>
                  {% endif %}

                  {% if w.is_available_now %}
                    <a href="tel:{{ w.phone_formatted }}" class="phone-button" data-track="call" data-worker="{{ w.worker_id }}" aria-label="{{ _('call_now') }} {{ w.company_name }} {{ w.phone_formatted }}">
                      <i class="fa-solid fa-phone fa-fw" aria-hidden="true"></i>{{ _('call_now') }}: <span dir="ltr" class="phone-num">{{ w.phone }}</span>
                    </a>
                  {% else %}
                    <p class="status status--bad"><i class="fa-solid fa-circle-xmark fa-fw" aria-hidden="true"></i>{{ _('not_available') }}</p>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>

          {% if pagination %}
            <nav class="pager" aria-label="עמוד">
              {% if pagination.prev %}<a class="page-nav prev" href="{{ pagination.prev_url }}">&laquo; הקודם</a>{% endif %}
              {% for p in pagination.pages %}
                {% if p.current %}<span class="page-num current" aria-current="page">{{ p.num }}</span>{% else %}<a class="page-num" href="{{ p.url }}">{{ p.num }}</a>{% endif %}
              {% endfor %}
              {% if pagination.next %}<a class="page-nav next" href="{{ pagination.next_url }}">הבא &raquo;</a>{% endif %}
            </nav>
          {% endif %}
        {% endif %}
      </section>
    </div>

    <section class="cta-min" aria-label="פרסום בעלי מקצוע">
      <div class="cta-min__box">
        <div>
          <strong>בעל מקצוע?</strong>
          <div style="color:#6b7280">הצטרפו בחינם והציגו דירוגים וביקורות.</div>
        </div>
        <a class="btn-min" href="{{ url_for_lang('contact') }}">דברו איתנו</a>
      </div>
    </section>

    <div class="drawer-overlay" id="filtersOverlay" hidden></div>
    <aside class="drawer-panel" id="filtersDrawer" aria-hidden="true" aria-modal="true" role="dialog" aria-labelledby="filtersTitle" hidden>
      <div class="drawer-head">
        <h2 id="filtersTitle" class="drawer-title">סינון</h2>
        <button type="button" class="drawer-close" id="filtersCloseBtn" aria-label="{{ _('close') or 'סגור' }}"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="drawer-body">
        {% set list_url = url_for('show_workers', lang=g.current_lang, field=field, area=area) %}
        <form method="get" action="{{ list_url }}" class="filters-form" id="filtersForm">
          {% set _filter_keys = ['open_now','verified','rating_4p','nearby_5km','lang_he','lang_en','lang_ru','page','sort'] %}
          {% for k, v in request.args.items() if k not in _filter_keys %}
            <input type="hidden" name="{{ k }}" value="{{ v }}">
          {% endfor %}
          <fieldset class="filter-group">
            <legend class="sr-only">מצב ותעדוף</legend>
            <label class="check"><input type="checkbox" name="open_now"  value="1" {{ 'checked' if request.args.get('open_now') else '' }}> פתוחים עכשיו</label>
            <label class="check"><input type="checkbox" name="verified"  value="1" {{ 'checked' if request.args.get('verified') else '' }}> מאומתים</label>
            <label class="check"><input type="checkbox" name="rating_4p" value="1" {{ 'checked' if request.args.get('rating_4p') else '' }}> 4★+</label>
            <label class="check"><input type="checkbox" name="nearby_5km" value="1" {{ 'checked' if request.args.get('nearby_5km') else '' }}> עד 5 ק״מ</label>
          </fieldset>
          <fieldset class="filter-group">
            <legend class="sr-only">שפה</legend>
            <div class="checks-grid">
              <label class="check"><input type="checkbox" name="lang_he" value="1" {{ 'checked' if request.args.get('lang_he') else '' }}> עברית</label>
              <label class="check"><input type="checkbox" name="lang_en" value="1" {{ 'checked' if request.args.get('lang_en') else '' }}> English</label>
              <label class="check"><input type="checkbox" name="lang_ru" value="1" {{ 'checked' if request.args.get('lang_ru') else '' }}> Русский</label>
            </div>
          </fieldset>
          <div class="filters-actions">
            <button type="submit" class="btn apply">החל מסננים</button>
            <a class="link-clear" href="{{ list_url }}">נקה</a>
          </div>
        </form>
      </div>
    </aside>
  </div>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script>
    (function(){
      function computeHeaderH(){
        const cand = document.querySelector('.navbar, .site-header, header[role="banner"], .topbar, .main-navbar');
        let h = 0; if (cand){ const cs = getComputedStyle(cand); if (cs.position==='fixed'||cs.position==='sticky'){ h = cand.offsetHeight||0; } }
        document.documentElement.style.setProperty('--header-h', h + 'px');
      }
      computeHeaderH(); window.addEventListener('resize', computeHeaderH); window.addEventListener('orientationchange', computeHeaderH); window.addEventListener('load', computeHeaderH);
    })();

    (function(){
      document.querySelectorAll('.media-player[data-kind="mp4"]').forEach(mp=>{
        const src = mp.dataset.src; const fallback = mp.dataset.fallback||'';
        try{ const v=document.createElement('video'); v.preload='auto'; v.src=src; v.crossOrigin='anonymous'; v.muted=true;
          v.addEventListener('loadedmetadata', ()=>{
            const t=Math.min(0.2,(v.duration||1)/10);
            const snap=()=>{ const c=document.createElement('canvas'); c.width=v.videoWidth||640; c.height=v.videoHeight||360; const ctx=c.getContext('2d'); ctx.drawImage(v,0,0,c.width,c.height); try{ const url=c.toDataURL('image/jpeg',0.85); if(url&&url.startsWith('data:image')) mp.style.setProperty('--poster',`url('${url}')`);}catch(e){ if(fallback) mp.style.setProperty('--poster',`url('${fallback}')`);} };
            const onSeeked=()=>{ snap(); v.removeEventListener('seeked',onSeeked); };
            v.addEventListener('seeked',onSeeked); try{ v.currentTime=t; }catch(e){ snap(); }
          },{once:true}); v.load();
        }catch(e){ if(fallback) mp.style.setProperty('--poster',`url('${fallback}')`); }
      });
    })();

    document.addEventListener('click', function(e){
      const play = e.target.closest('.play-overlay'); if(!play) return;
      const mp = play.closest('.media-player'); const inner=mp.querySelector('.media-inner');
      const kind=mp.dataset.kind; const src=mp.dataset.src; mp.classList.add('is-playing');
      if(kind==='mp4'){ const v=document.createElement('video'); v.controls=true; v.playsInline=true; v.autoplay=true; v.muted=false; v.style.objectFit='contain'; v.innerHTML='<source src="'+src+'" type="video/mp4">'; inner.innerHTML=''; inner.appendChild(v); if(v.play) v.play().catch(()=>{}); }
      else { const url = src + (src.includes('?')?'&':'?') + 'autoplay=1&mute=1&playsinline=1&fs=1&rel=0&modestbranding=1&controls=1'; const iframe=document.createElement('iframe'); iframe.src=url; iframe.setAttribute('allow','autoplay; encrypted-media; picture-in-picture; fullscreen'); iframe.setAttribute('allowfullscreen','1'); iframe.style.width='100%'; iframe.style.height='100%'; iframe.style.border='0'; inner.innerHTML=''; inner.appendChild(iframe); }
    }, {passive:true});

    (function(){
      const openBtn=document.getElementById('filtersOpenBtn');
      const overlay=document.getElementById('filtersOverlay');
      const drawer=document.getElementById('filtersDrawer');
      const closeBtn=document.getElementById('filtersCloseBtn');
      function openDrawer(){ drawer.hidden=false; requestAnimationFrame(()=>{ overlay.hidden=false; drawer.setAttribute('aria-hidden','false'); openBtn&&openBtn.setAttribute('aria-expanded','true'); document.documentElement.classList.add('drawer-open'); document.body.style.overflow='hidden'; }); }
      function closeDrawer(){ overlay.hidden=true; drawer.setAttribute('aria-hidden','true'); openBtn&&openBtn.setAttribute('aria-expanded','false'); document.documentElement.classList.remove('drawer-open'); document.body.style.overflow=''; drawer.hidden=true; }
      openBtn&&openBtn.addEventListener('click', openDrawer); closeBtn&&closeBtn.addEventListener('click', closeDrawer); overlay&&overlay.addEventListener('click', closeDrawer); document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeDrawer(); }, {passive:true});
    })();
  </script>
{% endblock %}
