{% extends 'base.html' %}

{% block title %}{{ _('title') }} {{ worker.company_name or worker.name }}{% endblock %}

{% block extra_head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ static_rel('css/worker_reviews.css') }}">
  <style>
    .emer-badge{
      display:inline-block;margin-inline-start:.5rem;font-size:.85rem;
      color:#0f5132;background:#d1e7dd;border:1px solid #badbcc;border-radius:999px;padding:2px 8px;
      vertical-align:middle
    }
  </style>
{% endblock %}

{% include 'navbar.html' %}

{% block content %}
<section class="worker-profile-section">

  <!-- מזהה העובד לצרכי מדידה -->
  <meta id="worker-meta" data-worker-id="{{ worker.worker_id }}"/>

  <!-- כפתור חזרה -->
  <a href="{{ back_url }}" class="back-button">{{ _('back_button') }}</a>

  <!-- HERO -->
  <header class="worker-hero" dir="{{ 'rtl' if g.current_lang == 'he' else 'ltr' }}">
    <div class="hero-layout">
      <div class="hero-left">
        <figure class="hero-avatar-wrap">
          {% if worker.image_url %}
            <img class="hero-avatar" src="{{ worker.image_url }}" alt="{{ worker.company_name or worker.name }}">
          {% else %}
            <img class="hero-avatar" src="{{ url_for('static', filename=worker.image_filename or 'default-worker.jpg') }}" alt="{{ worker.company_name or worker.name }}">
          {% endif %}
        </figure>

        <div class="hero-meta">
          <h1 class="hero-title">
            {{ worker.company_name or worker.name }}
            {% if worker.offers_emergency %}<span class="emer-badge">חירום 24/7</span>{% endif %}
          </h1>
          <div class="hero-sub">
            {{ worker.field_display or worker.field_translated or worker.field }}
            {% if worker.base_city %} · {{ worker.base_city }}{% endif %}
          </div>

          <div class="hero-cta">
            {% if worker.phone_formatted %}
              <a class="btn btn-call"
                 href="tel:{{ worker.phone_formatted }}"
                 aria-label="התקשר ל{{ worker.company_name or worker.name }}"
                 data-track="call"
                 data-worker="{{ worker.worker_id }}">
                {{ _('call_now') if _('call_now') != 'call_now' else 'התקשר עכשיו' }}
              </a>
              <a class="btn btn-wa"
                 href="https://wa.me/{{ (worker.phone_formatted or '')|replace('+','')|replace('-','')|replace(' ','') }}"
                 target="_blank" rel="noopener"
                 aria-label="שלח הודעת WhatsApp ל{{ worker.company_name or worker.name }}"
                 data-track="wa"
                 data-worker="{{ worker.worker_id }}">
                WhatsApp
              </a>
            {% endif %}

            {% if worker.is_available_now is defined %}
              <span class="availability-pill {{ 'on' if worker.is_available_now else 'off' }}">
                {{ 'זמין עכשיו' if worker.is_available_now else 'לא זמין כעת' }}
              </span>
            {% endif %}
          </div>
        </div>
      </div>

      {% if worker.hero_video_src %}
        <div class="hero-right">
          {% if worker.hero_video_kind == 'mp4' %}
            <video class="hero-video" src="{{ worker.hero_video_src }}" controls playsinline preload="metadata"></video>
          {% else %}
            <div class="hero-embed">
              <iframe
                src="{{ worker.hero_video_src }}"
                title="Intro video"
                loading="lazy"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </header>

  <!-- תוכן ראשי: רק מה שצריך -->
  <div class="worker-main-content">

    <!-- שמאל: מה אני עושה (רשימת שירותים) -->
    {% if worker.specializations %}
    <aside class="worker-services">
      <h2>מה אני עושה</h2>
      <ul>
        {% for s in worker.specializations %}
          <li>{{ s }}</li>
        {% endfor %}
      </ul>
    </aside>
    {% endif %}

    <!-- מרכז: אודות (טקסט נקי + ניסיון) -->
    <div class="worker-about">
      <h2>אודות</h2>
      {% set about_txt = worker.about_clean or worker.about %}
      {% if about_txt %}
        {% for para in about_txt.split('\n\n') %}
          <p>{{ para }}</p>
        {% endfor %}
      {% else %}
        <p>—</p>
      {% endif %}
      {% if worker.experience_text %}
        <p class="experience">{{ worker.experience_text }}</p>
      {% endif %}
    </div>

    <!-- ימין: חוות דעת -->
    <aside class="worker-reviews">
      <h2>חוות דעת של לקוחות</h2>
      {% if reviews and reviews|length > 0 %}
        <div class="reviews-list">
          {% for review in reviews %}
            <div class="review-item">
              <p class="review-text">
                💬 "{{ review.display_text or review.get('translations', {}).get(g.current_lang, review.get('text','')) }}"
                {% if review.get('author') %}- {{ review.author }}{% endif %}
              </p>
              {% if review.get('rating') %}
                <div class="review-rating" aria-label="דירוג {{ review.rating }}">
                  {% for i in range(1,6) %}{{ '★' if review.rating >= i else '☆' }}{% endfor %}
                </div>
              {% endif %}
              {% if review.get('job_done') %}
                <p class="review-job">העבודה שבוצעה: {{ review.job_done }}</p>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="no-reviews">{{ _('no_reviews') }}</p>
      {% endif %}
    </aside>

  </div>

  <!-- מידע נוסף: רק איזורי שירות -->
  {% if worker.service_areas %}
    <div class="worker-footer-info">
      <div class="worker-areas">
        <h3>איזורי שירות</h3>
        <p>{{ worker.service_areas|join(', ') }}</p>
      </div>
    </div>
  {% endif %}

</section>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <!-- מדידה: צפייה וקליקים -->
  <script>
    (function () {
      var meta = document.getElementById('worker-meta');
      var workerId = meta ? meta.getAttribute('data-worker-id') : null;

      if (typeof window.trackEvent !== 'function') {
        window.trackEvent = function (eventName, wid) {
          if (!eventName || !wid) return;
          var ev = String(eventName);
          if (ev === 'call') ev = 'click_call';
          else if (ev === 'wa') ev = 'click_whatsapp';
          var payload = JSON.stringify({ event: ev, worker_id: String(wid) });
          if (navigator.sendBeacon) {
            navigator.sendBeacon('/api/track', new Blob([payload], { type: 'application/json' }));
          } else {
            fetch('/api/track', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: payload,
              keepalive: true
            }).catch(function(){});
          }
        };
        document.addEventListener('click', function (e) {
          var el = e.target.closest('[data-track][data-worker]');
          if (!el) return;
          window.trackEvent(el.getAttribute('data-track'), el.getAttribute('data-worker'));
        }, { capture: true });
      }

      if (workerId) { window.trackEvent('view', workerId); }
    })();
  </script>
{% endblock %}
